# Implementation Plan: GitHub Issue #23 — Generate Briefing Items

**Issue**: [Generate briefing items](https://github.com/Disentangled-Tech/SignalForge/issues/23)  
**Store**:
- why now
- risks
- outreach draft

**Acceptance Criteria**:
- Data stored in briefing_items

---

## Architecture Context (CURSOR_PRD.md)

The PRD Daily Briefing section states:

> Once per day:
> 1. Select companies with activity in the last 14 days
> 2. Sort by score descending
> 3. Select top 5
> 4. Generate briefing entries
> 5. Store briefing
> 6. Optionally email to operator

The pipeline is:

```
companies → signals → analysis → scoring → briefing → outreach draft
```

The PRD’s three most important outputs:
1. Correct company stage classification
2. Clear explanation of “why now”
3. A believable human outreach draft

---

## Current State

### Data Model (BriefingItem)

| Field | Type | Issue Mapping | Status |
|-------|------|---------------|--------|
| `why_now` | Text | why now | ✅ Exists |
| `risk_summary` | Text | risks | ✅ Exists |
| `outreach_subject` | String(255) | outreach draft | ✅ Exists |
| `outreach_message` | Text | outreach draft | ✅ Exists |
| `suggested_angle` | Text | (extra) | — |
| `briefing_date` | Date | — | — |
| `company_id`, `analysis_id` | FK | — | — |

**Location**: `app/models/briefing_item.py`, migration `26bb8c9d58d5`

### Generation Pipeline

| Step | Location | Output |
|------|----------|--------|
| 1. Select top companies | `briefing.select_top_companies()` | list[Company] |
| 2. LLM briefing entry | `briefing_entry_v1` prompt | why_now, risk_summary, suggested_angle, next_step |
| 3. Outreach draft | `outreach.generate_outreach()` | subject, message |
| 4. Persist | `BriefingItem(...)` | Stored in briefing_items |

**Location**: `app/services/briefing.py` — `generate_briefing()` → `_generate_for_company()`

### Display

| Surface | why_now | risks | outreach draft |
|---------|---------|-------|----------------|
| Daily Briefing (`/briefing`) | ✅ | ✅ (risk_summary) | ✅ |
| Company Detail (`/companies/{id}`) | ❌ | ❌ | ✅ |
| Briefing email | ✅ | ✅ | ✅ |

---

## Gap Analysis: Issue #23 vs Current Implementation

| Requirement | Current State | Gap |
|-------------|---------------|-----|
| **Store why now** | `why_now` column; populated from LLM | ✅ None |
| **Store risks** | `risk_summary` column; populated from LLM | ✅ None |
| **Store outreach draft** | `outreach_subject` + `outreach_message`; populated from `generate_outreach()` | ✅ None |
| **Data stored in briefing_items** | All three persisted via `db.add(item)` + `db.commit()` | ✅ None |

**Conclusion**: The acceptance criteria are satisfied. All three fields are generated, stored in `briefing_items`, and displayed on the Daily Briefing page.

---

## Verification Checklist

- [x] `why_now` generated by `briefing_entry_v1` and stored in BriefingItem
- [x] `risk_summary` (risks) generated by `briefing_entry_v1` and stored in BriefingItem
- [x] Outreach draft generated by `generate_outreach()` and stored in BriefingItem
- [x] Daily Briefing page displays all three
- [x] Company detail page displays outreach draft (from latest BriefingItem)
- [x] Briefing email includes why_now, risk_summary, outreach
- [x] Tests: `test_creates_briefing_items` asserts all fields stored

---

## Optional Enhancements (Out of Scope for AC)

### 1. Company Detail Page — Show why_now and risks

**Current**: Company detail shows analysis (stage, pain signals, evidence, explanation) and outreach draft only.

**Optional**: When a BriefingItem exists for the company, show `why_now` and `risk_summary` in the outreach section. This would surface briefing context on the company page.

**Impact**: Low. Template change only. Not required by issue #23.

### 2. Prompt key alignment

The `briefing_entry_v1` prompt returns `risk_summary`; the issue uses “risks.” The mapping is clear. No change needed.

---

## Non-Breaking Changes Guarantee

No changes to existing behavior are required to satisfy issue #23. The implementation is complete.

If enhancements are added:
- Do not remove or rename existing columns
- Do not change the `generate_briefing` flow
- Preserve API contracts (`POST /briefing/generate`, `GET /briefing`, `GET /briefing/{date}`)
- Preserve internal job endpoint `POST /internal/run_briefing`

---

## Edge Cases (Already Handled)

| Case | Behavior |
|------|----------|
| LLM returns invalid JSON | `_parse_json_safe` returns None; empty strings stored |
| LLM omits a key | `parsed.get("why_now", "")` etc. — empty string stored |
| `generate_outreach` fails | Exception propagates; company skipped; other companies still processed |
| Company has no analysis | `_generate_for_company` returns None; company skipped |

---

## Files Reference

| File | Purpose |
|------|---------|
| `app/models/briefing_item.py` | BriefingItem model |
| `app/services/briefing.py` | generate_briefing, _generate_for_company |
| `app/prompts/briefing_entry_v1.md` | LLM prompt for why_now, risk_summary |
| `app/services/outreach.py` | generate_outreach (subject, message) |
| `app/api/briefing_views.py` | /briefing, /briefing/generate |
| `app/templates/briefing/today.html` | Daily Briefing UI |
| `app/templates/companies/detail.html` | Company detail (outreach draft) |
| `app/services/email_service.py` | Briefing email (why_now, risk_summary, outreach) |
| `tests/test_briefing.py` | Unit tests for briefing pipeline |

---

## Summary

Issue #23 is satisfied by the current implementation. The briefing pipeline generates why_now, risks (risk_summary), and outreach draft, stores them in `briefing_items`, and surfaces them on the Daily Briefing page and in briefing emails. No code changes are required to meet the acceptance criteria.
