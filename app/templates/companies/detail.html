{% extends "base.html" %}

{% block title %}{{ company.company_name }} â€” SignalForge{% endblock %}

{% block content %}
{# â”€â”€ Company header â”€â”€ #}
<div class="card">
    <div class="header-row">
        <div>
            <h1 style="margin-bottom: 0.25rem;">{{ company.company_name }}</h1>
            <div class="text-muted">
                {% if company.website_url %}<a href="{{ company.website_url }}" target="_blank">{{ company.website_url }}</a> Â· {% endif %}
                {% if company.founder_name %}Founder: {{ company.founder_name }}{% endif %}
                {% if company.founder_linkedin_url %} Â· <a href="{{ company.founder_linkedin_url }}" target="_blank">Founder LinkedIn</a>{% endif %}
                {% if company.company_linkedin_url %} Â· <a href="{{ company.company_linkedin_url }}" target="_blank">Company LinkedIn</a>{% endif %}
            </div>
        </div>
        <div style="display: flex; gap: 0.5rem; align-items: center;">
            {% set display_score = recomputed_score if recomputed_score is not none else company.cto_need_score %}
            {% if display_score is not none %}
            <span class="badge {% if display_score > 70 %}badge-green{% elif display_score >= 40 %}badge-yellow{% else %}badge-red{% endif %}" style="font-size: 1.1rem; padding: 0.3rem 0.8rem;">
                Score: {{ display_score }}
            </span>
            {% if recomputed_score is not none and company.cto_need_score != recomputed_score %}
            <span class="text-muted" style="font-size: 0.75rem;">(stored: {{ company.cto_need_score or 'â€”' }})</span>
            {% endif %}
            {% endif %}
            {% if company.current_stage %}
            <span class="badge badge-gray">{{ company.current_stage }}</span>
            {% endif %}
        </div>
    </div>
    {# â”€â”€ Metadata block â”€â”€ #}
    <div style="margin-top: 1rem; padding-top: 1rem; border-top: 1px solid #e2e8f0; font-size: 0.9rem; display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 0.5rem 1.5rem;">
        <div><strong>Source:</strong> {{ company.source.value if company.source else 'â€”' }}</div>
        {% if company.last_scan_at %}
        <div><strong>Last scan:</strong> {{ company.last_scan_at.strftime('%Y-%m-%d %H:%M') }}</div>
        {% endif %}
        {% if company.target_profile_match %}
        <div><strong>Target profile:</strong> âœ“</div>
        {% endif %}
        {% if company.notes %}
        <div style="grid-column: 1 / -1;"><strong>Notes:</strong> {{ company.notes }}</div>
        {% endif %}
    </div>
    {# â”€â”€ Rescan status and flash messages â”€â”€ #}
    {% if rescan_param == 'queued' %}
    <div class="text-muted" style="margin-top: 0.5rem;">Scan queued. The page will refresh automatically.</div>
    {% elif rescan_param == 'running' %}
    <div class="text-muted" style="margin-top: 0.5rem;">Scan already in progress.</div>
    {% endif %}
    {% if scan_job and scan_job.status == 'running' %}
    <div style="margin-top: 0.5rem; color: #0d9488;">Scan in progressâ€¦</div>
    {% elif scan_job and scan_job.status == 'failed' %}
    <div style="margin-top: 0.5rem; color: #dc2626;">Last scan failed: {{ scan_job.error_message or 'Unknown error' }}</div>
    {% elif scan_job and scan_job.status == 'completed' and scan_job.finished_at %}
    <div class="text-muted" style="margin-top: 0.5rem;">Last scan completed at {{ scan_job.finished_at.strftime('%Y-%m-%d %H:%M') }}</div>
    {% endif %}
    <div style="display: flex; gap: 0.5rem; margin-top: 0.75rem;">
        <a href="/companies/{{ company.id }}/edit{% if workspace_id %}?workspace_id={{ workspace_id }}{% endif %}" class="btn btn-secondary">Edit</a>
        <form method="POST" action="/companies/{{ company.id }}/rescan{% if workspace_id %}?workspace_id={{ workspace_id }}{% endif %}" style="display:inline;">
            {% if scan_job and scan_job.status == 'running' %}
            <button type="submit" class="btn btn-primary" disabled>âŸ³ Scanningâ€¦</button>
            {% else %}
            <button type="submit" class="btn btn-primary">âŸ³ Rescan</button>
            {% endif %}
        </form>
        <form method="POST" action="/companies/{{ company.id }}/delete" style="display:inline;" onsubmit="return confirm('Delete this company?');">
            <button type="submit" class="btn btn-danger">Delete</button>
        </form>
    </div>
</div>

{# â”€â”€ Latest Analysis â”€â”€ #}
<div class="card">
    <h2>Latest Analysis</h2>
    {% if analysis %}
    <div style="display: flex; gap: 2rem; margin-bottom: 1rem;">
        <div><strong>Stage:</strong> {{ analysis.stage or 'â€”' }}</div>
        <div><strong>Confidence:</strong> {{ analysis.stage_confidence or 0 }}%</div>
    </div>
    {% set pain_signals_raw = analysis.pain_signals_json|default({}) %}
    {% if pain_signals_raw is mapping %}
    <h2 style="font-size: 1rem;">Pain Signals</h2>
    <div style="display: flex; flex-wrap: wrap; gap: 0.5rem; margin-bottom: 1rem;">
        {% set pain_signals = pain_signals_raw.get('signals', pain_signals_raw) if pain_signals_raw is mapping else {} %}
        {% for key, val in (pain_signals.items() if pain_signals is mapping else []) %}
        {% set active = val.get('value', val) if val is mapping else val %}
        <span class="badge {% if active %}badge-green{% else %}badge-gray{% endif %}">
            {% if active %}âœ“{% else %}âœ—{% endif %} {{ key|replace('_', ' ')|title }}
        </span>
        {% endfor %}
    </div>
    {% endif %}
    {% for bullet in (analysis.evidence_bullets|default([])) %}
    {% if loop.first %}<h2 style="font-size: 1rem;">Evidence</h2><ul style="margin-left: 1.25rem; margin-bottom: 1rem;">{% endif %}
        <li style="margin-bottom: 0.25rem;">{{ bullet }}</li>
    {% if loop.last %}</ul>{% endif %}
    {% endfor %}
    {% if analysis.explanation %}
    <h2 style="font-size: 1rem;">Explanation</h2>
    <p>{{ analysis.explanation }}</p>
    {% endif %}
    {% else %}
    <p class="text-muted">No analysis yet. Click Rescan to analyze this company.</p>
    {% endif %}
</div>

{# â”€â”€ Latest Outreach Draft â”€â”€ #}
<div class="card">
    <h2>Latest Outreach Draft</h2>
    {% if briefing %}
    {% if briefing.why_now %}
    <div style="margin-bottom: 1rem;">
        <div style="font-size: 0.75rem; text-transform: uppercase; letter-spacing: 0.5px; color: #94a3b8; font-weight: 600; margin-bottom: 0.25rem;">Why Now</div>
        <p style="font-size: 0.9rem; color: #334155; line-height: 1.6; margin: 0;">{{ briefing.why_now }}</p>
    </div>
    {% endif %}
    {% if briefing.risk_summary %}
    <div style="margin-bottom: 1rem;">
        <div style="font-size: 0.75rem; text-transform: uppercase; letter-spacing: 0.5px; color: #94a3b8; font-weight: 600; margin-bottom: 0.25rem;">Risk Summary</div>
        <p style="font-size: 0.9rem; color: #334155; line-height: 1.6; margin: 0;">{{ briefing.risk_summary }}</p>
    </div>
    {% endif %}
    {% if briefing.outreach_subject %}
    <div style="margin-bottom: 0.5rem;"><strong>Subject:</strong> {{ briefing.outreach_subject }}</div>
    {% endif %}
    {% if briefing.outreach_message %}
    <div id="outreach-message" style="background: #f8fafc; padding: 1rem; border-radius: 6px; white-space: pre-wrap; font-size: 0.9rem; line-height: 1.6; margin-bottom: 0.75rem;">{{ briefing.outreach_message }}</div>
    <button class="btn btn-secondary" onclick="copyOutreach()">ðŸ“‹ Copy Message</button>
    {% endif %}
    {% else %}
    <p class="text-muted">No outreach draft yet. Run a daily briefing to generate an outreach draft.</p>
    {% endif %}
</div>

{# â”€â”€ Outreach History â”€â”€ #}
<div class="card">
    <h2>Outreach History</h2>
    {% if outreach_error %}
    <div class="text-muted" style="margin-bottom: 1rem; color: #dc2626;">{{ outreach_error }}</div>
    {% endif %}
    <form method="POST" action="/companies/{{ company.id }}/outreach{% if workspace_id %}?workspace_id={{ workspace_id }}{% endif %}" style="margin-bottom: 1.5rem;">
        <div style="display: grid; gap: 1rem; max-width: 600px;">
            <div>
                <label for="outreach_sent_at" style="display: block; font-weight: 600; margin-bottom: 0.25rem;">Sent date/time</label>
                <input type="datetime-local" id="outreach_sent_at" name="sent_at" required
                    value="{{ now_for_datetime_local or '' }}" style="width: 100%; padding: 0.5rem;">
            </div>
            <div>
                <label for="outreach_type" style="display: block; font-weight: 600; margin-bottom: 0.25rem;">Outreach type</label>
                <select id="outreach_type" name="outreach_type" required style="width: 100%; padding: 0.5rem;">
                    <option value="">â€” Select â€”</option>
                    <option value="email">Email</option>
                    <option value="linkedin_dm">LinkedIn DM</option>
                    <option value="warm_intro">Warm intro</option>
                    <option value="other">Other</option>
                </select>
            </div>
            <div>
                <label for="outreach_outcome" style="display: block; font-weight: 600; margin-bottom: 0.25rem;">Outcome (optional)</label>
                <select id="outreach_outcome" name="outcome" style="width: 100%; padding: 0.5rem;">
                    <option value="">â€” None â€”</option>
                    <option value="replied">Replied</option>
                    <option value="declined">Declined</option>
                    <option value="no_response">No response</option>
                    <option value="other">Other</option>
                </select>
            </div>
            <div>
                <label for="outreach_message" style="display: block; font-weight: 600; margin-bottom: 0.25rem;">Message</label>
                <textarea id="outreach_message" name="message" rows="4" placeholder="Optional: paste or type what you sent"
                    style="width: 100%; padding: 0.5rem;">{{ draft_message or '' }}</textarea>
            </div>
            <div>
                <label for="outreach_notes" style="display: block; font-weight: 600; margin-bottom: 0.25rem;">Notes (optional)</label>
                <textarea id="outreach_notes" name="notes" rows="2" placeholder="Outcome, follow-up, etc."
                    style="width: 100%; padding: 0.5rem;"></textarea>
            </div>
            <div>
                <button type="submit" class="btn btn-primary">Record Outreach</button>
            </div>
        </div>
    </form>
    {% if outreach_history %}
    <table>
        <thead>
            <tr>
                <th>Sent</th>
                <th>Type</th>
                <th>Outcome</th>
                <th>Message</th>
                <th>Notes</th>
                <th></th>
            </tr>
        </thead>
        <tbody>
            {% for o in outreach_history %}
            <tr>
                <td class="text-muted">{{ o.sent_at.strftime('%Y-%m-%d %H:%M') }}</td>
                <td><span class="badge badge-gray">{{ o.outreach_type|replace('_', ' ') }}</span></td>
                <td>
                    <form method="POST" action="/companies/{{ company.id }}/outreach/{{ o.id }}/edit{% if workspace_id %}?workspace_id={{ workspace_id }}{% endif %}" style="display: inline-flex; gap: 0.25rem; align-items: center;">
                        <select name="outcome" style="padding: 0.2rem 0.4rem; font-size: 0.8rem;">
                            <option value="">â€”</option>
                            <option value="replied" {% if o.outcome == 'replied' %}selected{% endif %}>Replied</option>
                            <option value="declined" {% if o.outcome == 'declined' %}selected{% endif %}>Declined</option>
                            <option value="no_response" {% if o.outcome == 'no_response' %}selected{% endif %}>No response</option>
                            <option value="other" {% if o.outcome == 'other' %}selected{% endif %}>Other</option>
                        </select>
                        <button type="submit" class="btn btn-secondary" style="padding: 0.2rem 0.5rem; font-size: 0.8rem;">Update</button>
                    </form>
                </td>
                <td style="max-width: 250px;">{% set msg = o.message or '' %}{{ msg[:100] }}{% if msg|length > 100 %}â€¦{% endif %}</td>
                <td style="max-width: 150px;">{% set n = o.notes or '' %}{{ n[:80] }}{% if n|length > 80 %}â€¦{% endif %}</td>
                <td>
                    <form method="POST" action="/companies/{{ company.id }}/outreach/{{ o.id }}/delete{% if workspace_id %}?workspace_id={{ workspace_id }}{% endif %}" style="display:inline;" onsubmit="return confirm('Delete this outreach record?');">
                        <button type="submit" class="btn btn-secondary" style="padding: 0.2rem 0.5rem; font-size: 0.8rem;">Delete</button>
                    </form>
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
    {% else %}
    <p class="text-muted">No outreach recorded yet. Use the form above to log outreach you send manually.</p>
    {% endif %}
</div>

{# â”€â”€ Latest Signals â”€â”€ #}
<div class="card">
    <h2>Latest Signals</h2>
    {% if signals %}
    <table>
        <thead>
            <tr>
                <th>Source Type</th>
                <th>URL</th>
                <th>Date</th>
                <th>Content</th>
            </tr>
        </thead>
        <tbody>
            {% for s in signals %}
            <tr>
                <td><span class="badge badge-gray">{{ s.source_type or 'unknown' }}</span></td>
                <td>{% set url = s.source_url or '' %}<a href="{{ url }}" target="_blank" style="font-size: 0.85rem;">{{ url[:60] }}{% if url|length > 60 %}â€¦{% endif %}</a></td>
                <td class="text-muted">{{ s.created_at.strftime('%Y-%m-%d') }}</td>
                <td style="max-width: 300px;">{% set content = s.content_text or '' %}{{ content[:200] }}{% if content|length > 200 %}â€¦{% endif %}</td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
    {% else %}
    <p class="text-muted">No signals collected yet.</p>
    {% endif %}
</div>

{% block extra_head %}
{% if scan_job and scan_job.status == 'running' %}
<meta http-equiv="refresh" content="5">
{% endif %}
{% endblock %}

<script>
function copyOutreach() {
    const el = document.getElementById('outreach-message');
    if (el) {
        navigator.clipboard.writeText(el.textContent.trim()).then(() => {
            const btn = event.target;
            btn.textContent = 'âœ“ Copied!';
            setTimeout(() => { btn.textContent = 'ðŸ“‹ Copy Message'; }, 2000);
        });
    }
}
</script>
{% endblock %}

