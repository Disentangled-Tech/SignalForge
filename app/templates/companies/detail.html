{% extends "base.html" %}

{% block title %}{{ company.company_name }} â€” SignalForge{% endblock %}

{% block content %}
{# â”€â”€ Company header â”€â”€ #}
<div class="card">
    <div class="header-row">
        <div>
            <h1 style="margin-bottom: 0.25rem;">{{ company.company_name }}</h1>
            <div class="text-muted">
                {% if company.website_url %}<a href="{{ company.website_url }}" target="_blank">{{ company.website_url }}</a> Â· {% endif %}
                {% if company.founder_name %}Founder: {{ company.founder_name }}{% endif %}
                {% if company.founder_linkedin_url %} Â· <a href="{{ company.founder_linkedin_url }}" target="_blank">Founder LinkedIn</a>{% endif %}
                {% if company.company_linkedin_url %} Â· <a href="{{ company.company_linkedin_url }}" target="_blank">Company LinkedIn</a>{% endif %}
            </div>
        </div>
        <div style="display: flex; gap: 0.5rem; align-items: center;">
            {% set display_score = recomputed_score if recomputed_score is not none else company.cto_need_score %}
            {% if display_score is not none %}
            <span class="badge {% if display_score > 70 %}badge-green{% elif display_score >= 40 %}badge-yellow{% else %}badge-red{% endif %}" style="font-size: 1.1rem; padding: 0.3rem 0.8rem;">
                Score: {{ display_score }}
            </span>
            {% if recomputed_score is not none and company.cto_need_score != recomputed_score %}
            <span class="text-muted" style="font-size: 0.75rem;">(stored: {{ company.cto_need_score or 'â€”' }})</span>
            {% endif %}
            {% endif %}
            {% if company.current_stage %}
            <span class="badge badge-gray">{{ company.current_stage }}</span>
            {% endif %}
        </div>
    </div>
    {# â”€â”€ Metadata block â”€â”€ #}
    <div style="margin-top: 1rem; padding-top: 1rem; border-top: 1px solid #e2e8f0; font-size: 0.9rem; display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 0.5rem 1.5rem;">
        <div><strong>Source:</strong> {{ company.source.value if company.source else 'â€”' }}</div>
        {% if company.last_scan_at %}
        <div><strong>Last scan:</strong> {{ company.last_scan_at.strftime('%Y-%m-%d %H:%M') }}</div>
        {% endif %}
        {% if company.target_profile_match %}
        <div><strong>Target profile:</strong> âœ“</div>
        {% endif %}
        {% if company.notes %}
        <div style="grid-column: 1 / -1;"><strong>Notes:</strong> {{ company.notes }}</div>
        {% endif %}
    </div>
    <div style="display: flex; gap: 0.5rem; margin-top: 0.75rem;">
        <form method="POST" action="/companies/{{ company.id }}/rescan" style="display:inline;">
            <button type="submit" class="btn btn-primary">âŸ³ Rescan</button>
        </form>
        <form method="POST" action="/companies/{{ company.id }}/delete" style="display:inline;" onsubmit="return confirm('Delete this company?');">
            <button type="submit" class="btn btn-danger">Delete</button>
        </form>
    </div>
</div>

{# â”€â”€ Latest Analysis â”€â”€ #}
<div class="card">
    <h2>Latest Analysis</h2>
    {% if analysis %}
    <div style="display: flex; gap: 2rem; margin-bottom: 1rem;">
        <div><strong>Stage:</strong> {{ analysis.stage or 'â€”' }}</div>
        <div><strong>Confidence:</strong> {{ analysis.stage_confidence or 0 }}%</div>
    </div>
    {% set pain_signals_raw = analysis.pain_signals_json|default({}) %}
    {% if pain_signals_raw is mapping %}
    <h2 style="font-size: 1rem;">Pain Signals</h2>
    <div style="display: flex; flex-wrap: wrap; gap: 0.5rem; margin-bottom: 1rem;">
        {% set pain_signals = pain_signals_raw.get('signals', pain_signals_raw) if pain_signals_raw is mapping else {} %}
        {% for key, val in (pain_signals.items() if pain_signals is mapping else []) %}
        {% set active = val.get('value', val) if val is mapping else val %}
        <span class="badge {% if active %}badge-green{% else %}badge-gray{% endif %}">
            {% if active %}âœ“{% else %}âœ—{% endif %} {{ key|replace('_', ' ')|title }}
        </span>
        {% endfor %}
    </div>
    {% endif %}
    {% for bullet in (analysis.evidence_bullets|default([])) %}
    {% if loop.first %}<h2 style="font-size: 1rem;">Evidence</h2><ul style="margin-left: 1.25rem; margin-bottom: 1rem;">{% endif %}
        <li style="margin-bottom: 0.25rem;">{{ bullet }}</li>
    {% if loop.last %}</ul>{% endif %}
    {% endfor %}
    {% if analysis.explanation %}
    <h2 style="font-size: 1rem;">Explanation</h2>
    <p>{{ analysis.explanation }}</p>
    {% endif %}
    {% else %}
    <p class="text-muted">No analysis yet. Click Rescan to analyze this company.</p>
    {% endif %}
</div>

{# â”€â”€ Latest Outreach Draft â”€â”€ #}
<div class="card">
    <h2>Latest Outreach Draft</h2>
    {% if briefing %}
    {% if briefing.outreach_subject %}
    <div style="margin-bottom: 0.5rem;"><strong>Subject:</strong> {{ briefing.outreach_subject }}</div>
    {% endif %}
    {% if briefing.outreach_message %}
    <div id="outreach-message" style="background: #f8fafc; padding: 1rem; border-radius: 6px; white-space: pre-wrap; font-size: 0.9rem; line-height: 1.6; margin-bottom: 0.75rem;">{{ briefing.outreach_message }}</div>
    <button class="btn btn-secondary" onclick="copyOutreach()">ðŸ“‹ Copy Message</button>
    {% endif %}
    {% else %}
    <p class="text-muted">No outreach draft yet. Run a daily briefing or rescan to generate one.</p>
    {% endif %}
</div>

{# â”€â”€ Latest Signals â”€â”€ #}
<div class="card">
    <h2>Latest Signals</h2>
    {% if signals %}
    <table>
        <thead>
            <tr>
                <th>Source Type</th>
                <th>URL</th>
                <th>Date</th>
                <th>Content</th>
            </tr>
        </thead>
        <tbody>
            {% for s in signals %}
            <tr>
                <td><span class="badge badge-gray">{{ s.source_type or 'unknown' }}</span></td>
                <td>{% set url = s.source_url or '' %}<a href="{{ url }}" target="_blank" style="font-size: 0.85rem;">{{ url[:60] }}{% if url|length > 60 %}â€¦{% endif %}</a></td>
                <td class="text-muted">{{ s.created_at.strftime('%Y-%m-%d') }}</td>
                <td style="max-width: 300px;">{% set content = s.content_text or '' %}{{ content[:200] }}{% if content|length > 200 %}â€¦{% endif %}</td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
    {% else %}
    <p class="text-muted">No signals collected yet.</p>
    {% endif %}
</div>

{% block extra_head %}{% endblock %}

<script>
function copyOutreach() {
    const el = document.getElementById('outreach-message');
    if (el) {
        navigator.clipboard.writeText(el.textContent.trim()).then(() => {
            const btn = event.target;
            btn.textContent = 'âœ“ Copied!';
            setTimeout(() => { btn.textContent = 'ðŸ“‹ Copy Message'; }, 2000);
        });
    }
}
</script>
{% endblock %}

