{% extends "base.html" %}

{% block title %}Companies — SignalForge{% endblock %}

{% block content %}
<div class="header-row">
    <h1>Companies</h1>
    <div>
        <form method="post" action="/companies/scan-all" style="display: inline;">
            <button type="submit" class="btn btn-secondary" {% if scan_all_running %}disabled{% endif %}>Scan all</button>
        </form>
        <a href="/companies/import" class="btn btn-secondary">Import</a>
        <a href="/companies/add" class="btn btn-primary">+ Add Company</a>
    </div>
</div>

<div class="card" style="margin-bottom: 1rem; padding: 0.75rem 1rem;">
    <form method="GET" action="/companies" style="display: flex; gap: 0.75rem; align-items: center;">
        <input type="hidden" name="sort_by" value="{{ sort_by or 'score' }}">
        <input type="hidden" name="order" value="{{ sort_order or 'desc' }}">
        <input type="text" name="search" value="{{ search or '' }}" placeholder="Search companies…" style="flex: 1;">
        <button type="submit" class="btn btn-secondary">Search</button>
        {% if search %}
        <a href="/companies?sort_by={{ sort_by or 'score' }}&order={{ sort_order or 'desc' }}" class="btn btn-secondary">Clear</a>
        {% endif %}
    </form>
</div>

<div class="card" style="margin-bottom: 1rem; padding: 0.75rem 1rem; display: flex; gap: 1rem; align-items: center; flex-wrap: wrap;">
    <span>Sort by:</span>
    {% set current_sort = sort_by or 'score' %}
    {% set current_order = sort_order or 'desc' %}
    {% set search_qs = 'search=' ~ search if search else '' %}
    {% set qs_sep = '&' if search_qs else '' %}
    {# Score: toggle asc/desc when on score; else default desc #}
    {% set score_order = 'asc' if (current_sort == 'score' and current_order == 'desc') else 'desc' %}
    {% set score_url = '/companies?sort_by=score&order=' ~ score_order ~ (qs_sep ~ search_qs if search_qs else '') %}
    {# Name: toggle when on name; else default asc #}
    {% set name_order = 'desc' if (current_sort == 'name' and current_order == 'asc') else 'asc' %}
    {% set name_url = '/companies?sort_by=name&order=' ~ name_order ~ (qs_sep ~ search_qs if search_qs else '') %}
    {# Last Scan: toggle when on last_scan_at; else default desc #}
    {% set last_scan_order = 'asc' if (current_sort == 'last_scan_at' and current_order == 'desc') else 'desc' %}
    {% set last_scan_url = '/companies?sort_by=last_scan_at&order=' ~ last_scan_order ~ (qs_sep ~ search_qs if search_qs else '') %}
    {# Created: toggle when on created_at; else default desc #}
    {% set created_order = 'asc' if (current_sort == 'created_at' and current_order == 'desc') else 'desc' %}
    {% set created_url = '/companies?sort_by=created_at&order=' ~ created_order ~ (qs_sep ~ search_qs if search_qs else '') %}
    <a href="{{ score_url }}" class="{% if current_sort == 'score' %}badge badge-green{% else %}btn btn-secondary{% endif %}" style="text-decoration: none;">Score {% if current_sort == 'score' %}{{ '↑' if current_order == 'asc' else '↓' }}{% endif %}</a>
    <a href="{{ name_url }}" class="{% if current_sort == 'name' %}badge badge-green{% else %}btn btn-secondary{% endif %}" style="text-decoration: none;">Name {% if current_sort == 'name' %}{{ '↑' if current_order == 'asc' else '↓' }}{% endif %}</a>
    <a href="{{ last_scan_url }}" class="{% if current_sort == 'last_scan_at' %}badge badge-green{% else %}btn btn-secondary{% endif %}" style="text-decoration: none;">Last Scan {% if current_sort == 'last_scan_at' %}{{ '↑' if current_order == 'asc' else '↓' }}{% endif %}</a>
    <a href="{{ created_url }}" class="{% if current_sort == 'created_at' %}badge badge-green{% else %}btn btn-secondary{% endif %}" style="text-decoration: none;">Created {% if current_sort == 'created_at' %}{{ '↑' if current_order == 'asc' else '↓' }}{% endif %}</a>
</div>

{% if companies %}
<table>
    <thead>
        <tr>
            <th>Name</th>
            <th>Score</th>
            <th>Stage</th>
            <th>Last Scan</th>
            <th>Founder</th>
            <th>Actions</th>
        </tr>
    </thead>
    <tbody>
        {% for c in companies %}
        <tr>
            <td><a href="/companies/{{ c.id }}">{{ c.company_name }}</a></td>
            <td>
                {% set display_score = company_scores[c.id] if c.id in company_scores else c.cto_need_score %}
                {% if display_score is not none %}
                <span class="badge {% if display_score > 70 %}badge-green{% elif display_score >= 40 %}badge-yellow{% else %}badge-red{% endif %}">
                    {{ display_score }}
                </span>
                {% else %}
                <span class="badge badge-gray">—</span>
                {% endif %}
            </td>
            <td>{{ c.current_stage or '—' }}</td>
            <td>{{ c.last_scan_at.strftime('%Y-%m-%d %H:%M') if c.last_scan_at else '—' }}</td>
            <td>{{ c.founder_name or '—' }}</td>
            <td>
                <a href="/companies/{{ c.id }}" class="btn btn-secondary" style="padding: 0.3rem 0.6rem; font-size: 0.8rem;">View</a>
            </td>
        </tr>
        {% endfor %}
    </tbody>
</table>
{% else %}
<div class="card" style="text-align: center; padding: 3rem;">
    <p class="text-muted">No companies found.</p>
    <a href="/companies/add" class="btn btn-primary" style="margin-top: 1rem;">Add your first company</a>
</div>
{% endif %}

{% if total and total > page_size %}
<div class="card" style="margin-top: 1rem; padding: 0.75rem 1rem; display: flex; gap: 1rem; align-items: center; flex-wrap: wrap;">
    {% set pagination_base = '/companies?sort_by=' ~ (sort_by or 'score') ~ '&order=' ~ (sort_order or 'desc') %}
    {% set pagination_base = pagination_base ~ ('&search=' ~ search if search else '') %}
    <span>Page {{ page }} of {{ total_pages }} ({{ total }} total)</span>
    {% if page > 1 %}
    <a href="{{ pagination_base }}&page={{ page - 1 }}" class="btn btn-secondary">Previous</a>
    {% endif %}
    {% if page < total_pages %}
    <a href="{{ pagination_base }}&page={{ page + 1 }}" class="btn btn-secondary">Next</a>
    {% endif %}
</div>
{% endif %}
{% endblock %}

