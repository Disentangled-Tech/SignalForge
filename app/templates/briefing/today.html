{% extends "base.html" %}

{% block title %}Daily Briefing â€” SignalForge{% endblock %}

{% block extra_head %}
<style>
    .briefing-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem; flex-wrap: wrap; gap: 1rem; }
    .briefing-header h1 { margin-bottom: 0; }
    .date-nav { display: flex; align-items: center; gap: 0.75rem; font-size: 0.9rem; }
    .date-nav a { color: #2563eb; }
    .briefing-card { background: #fff; border-radius: 8px; padding: 1.5rem; box-shadow: 0 1px 3px rgba(0,0,0,0.08); margin-bottom: 1.5rem; }
    .company-header { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 1rem; flex-wrap: wrap; gap: 0.5rem; }
    .company-title { display: flex; align-items: center; gap: 0.75rem; flex-wrap: wrap; }
    .company-title a { font-size: 1.15rem; font-weight: 700; color: #1a1a2e; }
    .company-title a:hover { color: #2563eb; }
    .founder { font-size: 0.85rem; color: #64748b; }
    .score-badge { display: inline-flex; align-items: center; gap: 0.3rem; background: #eff6ff; color: #1e40af; padding: 0.25rem 0.6rem; border-radius: 12px; font-size: 0.8rem; font-weight: 600; }
    .stage-badge { display: inline-block; padding: 0.2rem 0.6rem; border-radius: 12px; font-size: 0.75rem; font-weight: 600; text-transform: capitalize; }
    .stage-idea { background: #f1f5f9; color: #64748b; }
    .stage-mvp_building { background: #dbeafe; color: #1e40af; }
    .stage-early_customers { background: #d1fae5; color: #065f46; }
    .stage-scaling_team { background: #ffedd5; color: #9a3412; }
    .stage-enterprise_transition { background: #ede9fe; color: #5b21b6; }
    .stage-struggling_execution { background: #fee2e2; color: #991b1b; }
    .section-label { font-size: 0.75rem; text-transform: uppercase; letter-spacing: 0.5px; color: #94a3b8; font-weight: 600; margin-bottom: 0.25rem; margin-top: 1rem; }
    .section-text { font-size: 0.9rem; color: #334155; line-height: 1.7; }
    .outreach-block { background: #f8fafc; border: 1px solid #e2e8f0; border-radius: 6px; padding: 1rem; margin-top: 1rem; }
    .outreach-subject { font-weight: 600; font-size: 0.95rem; margin-bottom: 0.5rem; color: #1e293b; }
    .outreach-message { font-size: 0.9rem; color: #475569; white-space: pre-wrap; line-height: 1.6; }
    .copy-btn { display: inline-flex; align-items: center; gap: 0.3rem; margin-top: 0.75rem; padding: 0.4rem 0.8rem; background: #e2e8f0; color: #334155; border: none; border-radius: 6px; font-size: 0.8rem; cursor: pointer; font-family: inherit; }
    .copy-btn:hover { background: #cbd5e1; }
    .copy-btn.copied { background: #d1fae5; color: #065f46; }
    .empty-state { text-align: center; padding: 3rem 1rem; }
    .empty-state h2 { font-size: 1.3rem; color: #475569; margin-bottom: 0.75rem; }
    .empty-state p { color: #94a3b8; margin-bottom: 1.5rem; }

    .briefing-toolbar { display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 0.75rem; margin-bottom: 1rem; }
    .sort-controls { display: flex; align-items: center; gap: 0.5rem; font-size: 0.9rem; }
    .sort-label { color: #64748b; }
    .sort-link { color: #2563eb; padding: 0.25rem 0.5rem; border-radius: 4px; }
    .sort-link:hover { background: #eff6ff; text-decoration: none; }
    .sort-link.active { font-weight: 600; background: #dbeafe; color: #1e40af; }

    .emerging-section { margin-bottom: 2rem; }
    .emerging-section h2 { font-size: 1.2rem; color: #334155; margin-bottom: 1rem; }
    .emerging-card { background: #f8fafc; border: 1px solid #e2e8f0; border-radius: 8px; padding: 1rem 1.25rem; margin-bottom: 1rem; }
    .emerging-card .company-link { font-weight: 600; color: #1a1a2e; }
    .emerging-card .company-link:hover { color: #2563eb; }
    .emerging-dimensions { display: flex; gap: 0.5rem; flex-wrap: wrap; margin-top: 0.5rem; font-size: 0.75rem; color: #64748b; }
    .emerging-dim { padding: 0.15rem 0.4rem; background: #e2e8f0; border-radius: 4px; }
    .emerging-signals { margin-top: 0.5rem; font-size: 0.85rem; color: #475569; }
    .emerging-signals ul { margin: 0; padding-left: 1.25rem; }
    .emerging-badges { display: flex; flex-wrap: wrap; gap: 0.5rem; align-items: center; margin-top: 0.5rem; }
    .emerging-recommendation { font-size: 0.75rem; padding: 0.2rem 0.5rem; border-radius: 4px; background: #e0e7ff; color: #3730a3; }
    .emerging-cooldown { font-size: 0.75rem; padding: 0.2rem 0.5rem; border-radius: 4px; background: #fef3c7; color: #92400e; }

    .print-header { display: none; }
    @media print {
        nav, .btn, .copy-btn, .date-nav, form, .no-print { display: none !important; }
        .print-header { display: block !important; font-size: 1.1rem; font-weight: 600; margin-bottom: 1rem; }
        body { background: #fff; }
        .container { max-width: 100%; margin: 0; padding: 0.5rem; }
        .briefing-card { box-shadow: none; border: 1px solid #e2e8f0; break-inside: avoid; page-break-inside: avoid; }
        .outreach-block { background: #fff; }
    }
</style>
{% endblock %}

{% block content %}
<div class="print-header">SignalForge Briefing â€” {{ briefing_date.strftime('%A, %B %d, %Y') }}</div>
{% if job_has_failures %}
<div class="flash error no-print" style="margin-bottom: 1rem;">Last briefing job had failures. <a href="/settings">See Settings â†’ Recent Job Runs</a> for details.</div>
{% endif %}
<div class="briefing-header">
    <div>
        <h1>Daily Briefing</h1>
        <div class="date-nav">
            <a href="/briefing/{{ prev_date }}">&larr; Previous</a>
            <span>{{ briefing_date.strftime('%A, %B %d, %Y') }}</span>
            {% if next_date %}
            <a href="/briefing/{{ next_date }}">Next &rarr;</a>
            {% endif %}
        </div>
    </div>
    <div>
        <form method="post" action="/briefing/generate" style="display:inline;">
            <button type="submit" class="btn btn-primary">Generate Now</button>
        </form>
    </div>
</div>

<section class="emerging-section no-print">
    <h2>Emerging Companies to Watch</h2>
    {% if emerging_companies %}
    {% for ec in emerging_companies %}
    <div class="emerging-card">
        <div class="company-header">
            <div class="company-title">
                <a href="/companies/{{ ec.company.id }}" class="company-link">{{ ec.company.name }}</a>
                {% if ec.company.website_url %}
                <a href="{{ ec.company.website_url }}" target="_blank" rel="noopener" style="font-size:0.85rem;color:#64748b;">Website</a>
                {% endif %}
            </div>
            <span class="score-badge">Outreach: {{ ec.outreach_score }}</span>
        </div>
        <div class="emerging-badges">
            <span class="emerging-recommendation">{{ ec.engagement_type }}</span>
            {% if ec.cadence_blocked %}
            <span class="emerging-cooldown">Cooldown active</span>
            {% endif %}
        </div>
        <div class="emerging-dimensions">
            <span class="emerging-dim">TRS {{ ec.snapshot.composite }}</span>
            <span class="emerging-dim">ESL {{ "%.2f"|format(ec.esl_score) }}</span>
            <span class="emerging-dim">M {{ ec.snapshot.momentum }}</span>
            <span class="emerging-dim">C {{ ec.snapshot.complexity }}</span>
            <span class="emerging-dim">P {{ ec.snapshot.pressure }}</span>
            <span class="emerging-dim">G {{ ec.snapshot.leadership_gap }}</span>
        </div>
        {% if ec.top_signals %}
        <div class="emerging-signals">
            <ul>
            {% for signal in ec.top_signals %}
                <li>{{ signal }}</li>
            {% endfor %}
            </ul>
        </div>
        {% endif %}
    </div>
    {% endfor %}
    {% else %}
    <div class="empty-state" style="padding: 1.5rem 1rem;">
        <p style="margin:0;color:#94a3b8;">No emerging companies for this date. Run score nightly to populate readiness and engagement snapshots.</p>
    </div>
    {% endif %}
</section>

{% if items %}
<div class="briefing-toolbar no-print">
    <p class="text-muted" style="margin-bottom:0;">{{ items|length }} compan{{ 'y' if items|length == 1 else 'ies' }}</p>
    <div class="sort-controls">
        <span class="sort-label">Sort by:</span>
        <a href="{{ briefing_path }}?sort=score" class="sort-link{% if sort == 'score' %} active{% endif %}">Highest score</a>
        <a href="{{ briefing_path }}?sort=recent" class="sort-link{% if sort == 'recent' %} active{% endif %}">Most recent update</a>
        <a href="{{ briefing_path }}?sort=outreach" class="sort-link{% if sort == 'outreach' %} active{% endif %}">Last outreach</a>
        <a href="{{ briefing_path }}?sort=outreach_score" class="sort-link{% if sort == 'outreach_score' %} active{% endif %}">By outreach score</a>
    </div>
</div>

{% for item in items %}
<div class="briefing-card">
    <div class="company-header">
        <div class="company-title">
            <a href="/companies/{{ item.company.id }}">{{ item.company.name }}</a>
            {% set stage = item.analysis.stage or item.company.current_stage or 'unknown' %}
            <span class="stage-badge stage-{{ stage }}">{{ stage|replace('_', ' ') }}</span>
            {% if item.company.founder_name %}
            <span class="founder">Founded by {{ item.company.founder_name }}</span>
            {% endif %}
        </div>
        {% set item_score = display_scores.get(item.company.id) if item.company.id in display_scores else item.company.cto_need_score %}
        {% if item_score is not none %}
        <span class="score-badge">CTO Score: {{ item_score }}</span>
        {% endif %}
    </div>

    {% if item.why_now %}
    <div class="section-label">Why Now</div>
    <div class="section-text">{{ item.why_now }}</div>
    {% endif %}

    {% if item.risk_summary %}
    <div class="section-label">Risk Summary</div>
    <div class="section-text">{{ item.risk_summary }}</div>
    {% endif %}

    {% if item.suggested_angle %}
    <div class="section-label">Suggested Angle</div>
    <div class="section-text">{{ item.suggested_angle }}</div>
    {% endif %}

    {% if item.outreach_subject or item.outreach_message %}
    <div class="outreach-block">
        {% if item.outreach_subject %}
        <div class="outreach-subject">Subject: {{ item.outreach_subject }}</div>
        {% endif %}
        {% if item.outreach_message %}
        <div class="outreach-message">{{ item.outreach_message }}</div>
        {% endif %}
        <button class="copy-btn" onclick="copyOutreach(this, {{ item.id }})" data-subject="{{ item.outreach_subject or '' }}" data-message="{{ item.outreach_message or '' }}">ðŸ“‹ Copy Outreach</button>
    </div>
    {% endif %}
</div>
{% endfor %}

{% else %}
<div class="empty-state">
    <h2>No briefing for {{ briefing_date.strftime('%B %d, %Y') }}</h2>
    <p>No briefing items have been generated for this date yet.</p>
    <form method="post" action="/briefing/generate">
        <button type="submit" class="btn btn-primary">Generate Now</button>
    </form>
    {% if briefing_date != today %}
    <p style="margin-top:1rem;"><a href="/briefing">Back to today</a></p>
    {% endif %}
</div>
{% endif %}

<script>
function copyOutreach(btn, itemId) {
    const subject = btn.getAttribute('data-subject');
    const message = btn.getAttribute('data-message');
    const text = (subject ? 'Subject: ' + subject + '\n\n' : '') + message;
    navigator.clipboard.writeText(text).then(function() {
        btn.textContent = 'âœ“ Copied!';
        btn.classList.add('copied');
        setTimeout(function() {
            btn.textContent = 'ðŸ“‹ Copy Outreach';
            btn.classList.remove('copied');
        }, 2000);
    });
}
</script>
{% endblock %}

